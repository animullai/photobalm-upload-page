<!doctype html>
<html class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@^3/dist/tailwind.min.css" rel="stylesheet">
  <title>Photobalm â€¢ Instant Photo Quote</title>
</head>
<body class="h-full flex items-center justify-center">

  <div class="bg-white shadow-2xl rounded-2xl p-8 w-full max-w-md">
    <h1 class="text-2xl font-semibold text-center mb-6">Upload your photo</h1>

    <form id="form" class="space-y-4">
      <input id="file" type="file" accept="image/*"
             class="block w-full text-sm text-slate-800
                    file:mr-4 file:py-2 file:px-4
                    file:border-0 file:text-sm file:font-semibold
                    file:bg-emerald-600 file:text-white
                    hover:file:bg-emerald-700 cursor-pointer" required>

      <button class="w-full py-2 bg-emerald-600 hover:bg-emerald-700
                     text-white font-medium rounded-xl transition">
        Get AI quote
      </button>
    </form>

    <pre id="result" class="mt-6 whitespace-pre-wrap text-gray-800"></pre>
  </div>

<script type="module">
/* ---------- 1.  TEMP upload to Cloudflare Images ---------- */
async function directUpload(file){
  // get a one-time upload URL from your Cloudflare Images dashboard
  const tokenResp = await fetch('https://api.cloudflare.com/client/v4/accounts/YOUR_ACCOUNT_ID/images/v2/direct_upload', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer YOUR_IMAGES_TOKEN' }
  }).then(r => r.json());

  const uploadURL = tokenResp.result.uploadURL;
  const fd = new FormData();
  fd.append('file', file);
  const upResp = await fetch(uploadURL,{ method:'POST', body: fd })
                       .then(r=>r.json());
  return upResp.result.variants[0];       // public https URL
}

/* ---------- 2.  Call the Worker for analysis ---------- */
const WORKER = 'https://photobalm-webhook.photobalm.workers.dev';

document.getElementById('form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const file = document.getElementById('file').files[0];
  if(!file) return;

  document.getElementById('result').textContent = 'Analysing imageâ€¦ ðŸ”Ž';

  try{
    const url  = await directUpload(file);
    const res  = await fetch(WORKER,{
                   method:'POST',
                   headers:{'Content-Type':'application/json'},
                   body: JSON.stringify({ image_url: url })
                 }).then(r=>r.json());
    document.getElementById('result').textContent = res.reply;
  }catch(err){
    document.getElementById('result').textContent =
      'Sorry, something went wrong. Please try again.';
  }
});
</script>
</body>
</html>
