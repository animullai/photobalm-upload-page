<script type="module">
/* ---------- 1. get DOM handles ---------- */
const fileInp = document.querySelector('#file');
const goBtn   = document.querySelector('#go');
const result  = document.querySelector('#result');

/* ---------- 2. endpoints ---------- */
const WORKER = 'https://photobalm-webhook.photobalm.workers.dev';   // already fine

// ðŸ‘‰ replace the next two placeholders (keep the quotes)
const ACCOUNT_ID = 'ad633e37cbbb7cba033ab41483482e56';          // e.g. ad633e37cb...
const IMAGES_TOKEN = 'iKo_f8WwXCdqG9NzBplbLzg6PUhMLFxD5X_HBsXx';      // the long token you created

const DIRECT = `https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/images/v2/direct_upload`;
const CHAT   = WORKER;    // Workerâ€™s root handles chat

/* ---------- 3. handle click ---------- */
goBtn.addEventListener('click', async () => {
  const file = fileInp.files[0];
  if (!file) { result.textContent = 'Please choose an image first.'; return; }

  try {
    /* 3a. get 1-time upload URL from Cloudflare Images */
    const upRes = await fetch(DIRECT, {
      method: 'POST',
      headers: { Authorization: `Bearer ${IMAGES_TOKEN}` }
    }).then(r => r.json());
    const uploadURL = upRes.uploadURL;

    /* 3b. upload the actual file */
    const fd = new FormData(); fd.append('file', file);
    const imRes = await fetch(uploadURL, { method:'POST', body: fd })
                        .then(r => r.json());
    const imageURL = imRes.result.variants[0];      // public https URL

    /* 3c. send image URL to your chatbot Worker */
    const chatRes = await fetch(CHAT, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ message:'', image_url:imageURL })
    }).then(r=>r.json());

    result.textContent = chatRes.reply;
  } catch (err) {
    console.error(err);
    result.textContent = 'Sorry, something went wrong. Please try again.';
  }
});
</script>
